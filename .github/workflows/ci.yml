name: ðŸ§ª CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    - name: ðŸ“¦ Install dependencies
      working-directory: ./apps/frontend
      run: npm ci

    - name: ðŸ§ª Run linting
      working-directory: ./apps/frontend
      run: npm run lint

    - name: ðŸ—ï¸ Build application
      working-directory: ./apps/frontend
      run: npm run build

    - name: ðŸ“Š Build size analysis
      run: |
        echo "ðŸ“Š Build size analysis:"
        du -sh apps/frontend/.next/ || echo "Build directory not found"

  backend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ðŸ“¦ Install dependencies
      working-directory: ./apps/backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ðŸ§ª Run Python linting
      working-directory: ./apps/backend
      run: |
        # Install flake8 if not in requirements
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: ðŸ§ª Run backend tests
      working-directory: ./apps/backend
      run: |
        # Add your actual test command here
        echo "Backend tests would run here"
        # python -m pytest tests/ || echo "No tests found"

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ðŸ”§ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ðŸ”’ Frontend security audit
      run: |
        npm audit --audit-level=high || echo "Security vulnerabilities found"

    - name: ðŸ”’ Backend security audit
      working-directory: ./apps/backend
      run: |
        pip install safety
        safety check || echo "Security vulnerabilities found"

  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ“Š Code quality checks
      run: |
        echo "ðŸ“Š Running code quality checks..."
        
        # Check for TODO/FIXME comments
        echo "ðŸ” Checking for TODO/FIXME comments:"
        grep -r "TODO\|FIXME" . || echo "No TODO/FIXME found"
        
        # Check for console.log statements
        echo "ðŸ” Checking for console.log statements:"
        grep -r "console\.log" . || echo "No console.log found"
        
        # Check file sizes
        echo "ðŸ“Š Large files (>1MB):"
        find . -type f -size +1M -exec ls -lh {} \; || echo "No large files found"


