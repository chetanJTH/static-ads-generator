name: ðŸš€ Deploy to DigitalOcean

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    - name: ðŸ”§ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ðŸ“¦ Install frontend dependencies
      run: npm ci

    - name: ðŸ§ª Run frontend tests
      run: npm run lint

    - name: ðŸ—ï¸ Build frontend
      run: npm run build

    - name: ðŸ“¦ Install backend dependencies
      working-directory: ./apps/api
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ðŸ§ª Run backend tests
      working-directory: ./apps/api
      run: |
        # Add your backend tests here if you have them
        echo "Backend tests would run here"

    - name: ðŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: ðŸš€ Deploy to DigitalOcean
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        # Add server to known hosts
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # Deploy to server
        ssh ubuntu@${{ secrets.SERVER_HOST }} << 'EOF'
          cd /home/ubuntu/static-ads-generator
          
          echo "ðŸ“¥ Pulling latest code from Git..."
          git pull origin main
          
          echo "ðŸ”§ Setting up backend..."
          cd apps/api
          source venv/bin/activate
          pip install -r requirements.txt
          
          echo "ðŸŽ¨ Setting up frontend..."
          cd /home/ubuntu/static-ads-generator
          npm ci
          npm run build
          
          echo "ðŸ”„ Restarting applications with PM2..."
          cd /home/ubuntu/static-ads-generator
          pm2 stop all
          
          cd apps/api
          pm2 start ecosystem.config.js --env production
          
          cd /home/ubuntu/static-ads-generator
          pm2 start ecosystem.config.js --env production
          
          pm2 save
          
          echo "âœ… Deployment complete!"
          echo "ðŸŒ Frontend: https://kraftey.com"
          echo "ðŸŒ Backend: https://staticapi.kraftey.com"
        EOF

    - name: ðŸ“Š Deployment Status
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        ssh ubuntu@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "ðŸ“Š PM2 Status:"
          pm2 status
          
          echo "ðŸ“ Recent logs:"
          pm2 logs --lines 10
        EOF

  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸ¥ Health Check Frontend
      run: |
        sleep 30  # Wait for deployment to complete
        curl -f https://kraftey.com || exit 1
        echo "âœ… Frontend is healthy"

    - name: ðŸ¥ Health Check Backend
      run: |
        curl -f https://staticapi.kraftey.com/health || exit 1
        echo "âœ… Backend is healthy"

    - name: ðŸ“¢ Notify Deployment Success
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "ðŸŒ Frontend: https://kraftey.com"
        echo "ðŸŒ Backend: https://staticapi.kraftey.com"
        echo "ðŸ“Š API Docs: https://staticapi.kraftey.com/docs"