name: ğŸš€ Deploy to DigitalOcean

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    - name: ğŸ”§ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸ“¦ Install frontend dependencies
      working-directory: ./apps/frontend
      run: npm ci

    - name: ğŸ§ª Run frontend tests
      working-directory: ./apps/frontend
      run: npm run lint

    - name: ğŸ—ï¸ Build frontend
      working-directory: ./apps/frontend
      run: npm run build

    - name: ğŸ“¦ Install backend dependencies
      working-directory: ./apps/backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Run backend tests
      working-directory: ./apps/backend
      run: |
        # Add your backend tests here if you have them
        echo "Backend tests would run here"

    - name: ğŸš€ Deploy to DigitalOcean
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        # Install sshpass for password authentication
        sudo apt-get update && sudo apt-get install -y sshpass
        
        # Deploy to server using password authentication
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password root@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "ğŸš€ Starting monorepo deployment..."
          
          # Install Node.js and PM2 if not already installed
          if ! command -v node &> /dev/null; then
            echo "ğŸ“¦ Installing Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            apt-get install -y nodejs
          fi
          
          if ! command -v pm2 &> /dev/null; then
            echo "ğŸ“¦ Installing PM2..."
            npm install -g pm2
          else
            echo "ğŸ”„ Updating PM2..."
            pm2 update
          fi
          
          # Install Python and pip if not already installed
          if ! command -v python3 &> /dev/null; then
            echo "ğŸ“¦ Installing Python3..."
            apt-get install -y python3 python3-pip
          fi
          
          # Create deployment directory
          mkdir -p /opt/hosting/static-ads-generator
          
          # Navigate to monorepo directory
          cd /opt/hosting/static-ads-generator
        EOF

        # Copy the entire project to server
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' scp -r -o StrictHostKeyChecking=no . root@${{ secrets.SERVER_HOST }}:/opt/hosting/static-ads-generator/

        # Continue with server setup
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password root@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "ğŸ“ Code copied to server, setting up..."
          
          # Navigate to monorepo directory
          cd /opt/hosting/static-ads-generator
          
          echo "ğŸ“¦ Installing frontend dependencies..."
          cd apps/frontend
          npm ci --production
          
          echo "ğŸ“¦ Installing backend dependencies..."
          cd ../backend
          pip3 install -r requirements.txt
          
          echo "ğŸ—ï¸ Building frontend..."
          cd ../frontend
          npm run build
          
          echo "ğŸ”„ Restarting applications with PM2..."
          cd /opt/hosting/static-ads-generator
          pm2 restart ecosystem.config.js
          
          # Save PM2 configuration
          pm2 save
          
          # Show final status
          echo "ğŸ“Š Final PM2 Status:"
          pm2 status
          
          echo "âœ… Monorepo deployment complete!"
          echo "ğŸŒ Frontend: https://kraftey.com"
          echo "ğŸŒ Backend: https://staticapi.kraftey.com"
        EOF


  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ¥ Health Check Frontend
      run: |
        sleep 30  # Wait for deployment to complete
        curl -f https://kraftey.com || exit 1
        echo "âœ… Frontend is healthy"

    - name: ğŸ¥ Health Check Backend
      run: |
        curl -f https://staticapi.kraftey.com/health || exit 1
        echo "âœ… Backend is healthy"

    - name: ğŸ“¢ Notify Deployment Success
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸŒ Frontend: https://kraftey.com"
        echo "ğŸŒ Backend: https://staticapi.kraftey.com"
        echo "ğŸ“Š API Docs: https://staticapi.kraftey.com/docs"