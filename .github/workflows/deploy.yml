name: ğŸš€ Deploy to DigitalOcean

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    - name: ğŸ”§ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸ“¦ Install frontend dependencies
      working-directory: ./apps/frontend
      run: npm ci

    - name: ğŸ§ª Run frontend tests
      working-directory: ./apps/frontend
      run: npm run lint

    - name: ğŸ—ï¸ Build frontend
      working-directory: ./apps/frontend
      run: npm run build

    - name: ğŸ“¦ Install backend dependencies
      working-directory: ./apps/backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Run backend tests
      working-directory: ./apps/backend
      run: |
        # Add your backend tests here if you have them
        echo "Backend tests would run here"

    - name: ğŸš€ Deploy to DigitalOcean
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      timeout-minutes: 30
      run: |
        # Install sshpass for password authentication
        sudo apt-get update && sudo apt-get install -y sshpass
        
        # Deploy to server using password authentication
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password root@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "ğŸš€ Starting monorepo deployment..."
          
          # Update package lists first
          apt-get update
          
          # Check Node.js version and install/upgrade if needed
          NODE_VERSION=""
          if command -v node &> /dev/null; then
            NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
            echo "ğŸ” Current Node.js version: $(node --version)"
          fi
          
          # Install or upgrade Node.js if not available or not version 18+
          if ! command -v node &> /dev/null || ! command -v npm &> /dev/null || [ "$NODE_VERSION" -lt 18 ] 2>/dev/null; then
            echo "ğŸ“¦ Installing/upgrading Node.js and npm..."
            
            # Remove existing Node.js packages to avoid conflicts
            echo "ğŸ§¹ Removing existing Node.js packages..."
            apt-get remove -y nodejs npm libnode72 nodejs-doc 2>/dev/null || true
            apt-get autoremove -y 2>/dev/null || true
            
            # Clean package cache
            apt-get clean
            
            # Install Node.js 18.x from NodeSource
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
            apt-get install -y nodejs
            
            # Verify installation
            if ! command -v node &> /dev/null; then
              echo "âŒ Node.js installation failed!"
              exit 1
            fi
            
            if ! command -v npm &> /dev/null; then
              echo "âŒ npm installation failed!"
              exit 1
            fi
            
            echo "âœ… Node.js $(node --version) and npm $(npm --version) installed successfully"
          else
            echo "âœ… Node.js $(node --version) and npm $(npm --version) already installed and up to date"
          fi
          
          # Install PM2 if not already installed
          if ! command -v pm2 &> /dev/null; then
            echo "ğŸ“¦ Installing PM2..."
            npm install -g pm2
            if ! command -v pm2 &> /dev/null; then
              echo "âŒ PM2 installation failed!"
              exit 1
            fi
            echo "âœ… PM2 installed successfully"
          else
            echo "ğŸ”„ Updating PM2..."
            npm install -g pm2@latest
            echo "âœ… PM2 updated successfully"
          fi
          
          # Install Python and pip if not already installed
          if ! command -v python3 &> /dev/null; then
            echo "ğŸ“¦ Installing Python3..."
            apt-get install -y python3 python3-pip python3-venv
            if ! command -v python3 &> /dev/null; then
              echo "âŒ Python3 installation failed!"
              exit 1
            fi
            echo "âœ… Python3 $(python3 --version) installed successfully"
          else
            echo "âœ… Python3 $(python3 --version) already installed"
          fi
          
          # Install curl for health checks
          if ! command -v curl &> /dev/null; then
            echo "ğŸ“¦ Installing curl..."
            apt-get install -y curl
            echo "âœ… curl installed successfully"
          else
            echo "âœ… curl already installed"
          fi
          
          # Install Nginx for SSL proxy
          if ! command -v nginx &> /dev/null; then
            echo "ğŸ“¦ Installing Nginx..."
            apt-get install -y nginx
            systemctl enable nginx
            echo "âœ… Nginx installed successfully"
          else
            echo "âœ… Nginx already installed"
          fi
          
          # Create deployment directory
          mkdir -p /opt/hosting/static-ads-generator
          
          # Navigate to monorepo directory
          cd /opt/hosting/static-ads-generator
        EOF

        # Copy project files using tar and ssh for better reliability
        echo "ğŸ“ Copying project files to server..."
        
        # Create a clean archive of the project
        echo "ğŸ“¦ Creating project archive..."
        tar --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.next' \
            --exclude='dist' \
            --exclude='build' \
            --exclude='out' \
            --exclude='coverage' \
            --exclude='.nyc_output' \
            --exclude='.cache' \
            --exclude='.turbo' \
            --exclude='*.log' \
            --exclude='*.tmp' \
            --exclude='.DS_Store' \
            --exclude='Thumbs.db' \
            --exclude='.env*' \
            -czf /tmp/project.tar.gz .
        
        # Transfer the archive with progress
        echo "ğŸš€ Transferring project archive..."
        echo "ğŸ“Š Archive size: $(du -h /tmp/project.tar.gz | cut -f1)"
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' scp -v -o StrictHostKeyChecking=no -o ConnectTimeout=60 -o ServerAliveInterval=30 -o ServerAliveCountMax=3 /tmp/project.tar.gz root@${{ secrets.SERVER_HOST }}:/tmp/
        
        if [ $? -ne 0 ]; then
          echo "âŒ File transfer failed!"
          exit 1
        fi
        echo "âœ… Archive transferred successfully"
        
        # Extract the archive on the server
        echo "ğŸ“‚ Extracting project files on server..."
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password root@${{ secrets.SERVER_HOST }} << 'EXTRACT_EOF'
          echo "ğŸ“‚ Extracting project files..."
          cd /opt/hosting/static-ads-generator
          tar -xzf /tmp/project.tar.gz
          rm -f /tmp/project.tar.gz
          echo "âœ… Project files extracted successfully"
        EXTRACT_EOF
        
        # Clean up local archive
        rm -f /tmp/project.tar.gz
        
        # Verify the copy was successful
        echo "ğŸ” Verifying file transfer..."
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password root@${{ secrets.SERVER_HOST }} << 'VERIFY_EOF'
          if [ -f "/opt/hosting/static-ads-generator/package.json" ]; then
            echo "âœ… Root package.json found"
          else
            echo "âŒ Root package.json not found - file transfer may have failed"
            exit 1
          fi
          
          if [ -f "/opt/hosting/static-ads-generator/apps/frontend/package.json" ]; then
            echo "âœ… Frontend package.json found"
          else
            echo "âŒ Frontend package.json not found - file transfer may have failed"
            exit 1
          fi
          
          if [ -f "/opt/hosting/static-ads-generator/apps/backend/requirements.txt" ]; then
            echo "âœ… Backend requirements.txt found"
          else
            echo "âŒ Backend requirements.txt not found - file transfer may have failed"
            exit 1
          fi
          
          if [ -f "/opt/hosting/static-ads-generator/ecosystem.config.js" ]; then
            echo "âœ… ecosystem.config.js found"
          else
            echo "âŒ ecosystem.config.js not found - file transfer may have failed"
            exit 1
          fi
          
          echo "âœ… File transfer verification completed successfully"
        VERIFY_EOF

        # Continue with server setup
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password root@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "ğŸ“ Code copied to server, setting up..."
          
          # Navigate to monorepo directory
          cd /opt/hosting/static-ads-generator
          
          # Verify we have the required tools
          if ! command -v npm &> /dev/null; then
            echo "âŒ npm not found! Cannot proceed with frontend setup."
            exit 1
          fi
          
          if ! command -v python3 &> /dev/null; then
            echo "âŒ python3 not found! Cannot proceed with backend setup."
            exit 1
          fi
          
          # Install frontend dependencies
          echo "ğŸ“¦ Installing frontend dependencies..."
          cd apps/frontend
          if [ -f package.json ]; then
            npm ci --production
            if [ $? -ne 0 ]; then
              echo "âŒ Frontend dependency installation failed!"
              exit 1
            fi
            echo "âœ… Frontend dependencies installed successfully"
          else
            echo "âŒ package.json not found in frontend directory!"
            exit 1
          fi
          
          # Install backend dependencies
          echo "ğŸ“¦ Installing backend dependencies..."
          cd ../backend
          if [ -f requirements.txt ]; then
            pip3 install -r requirements.txt
            if [ $? -ne 0 ]; then
              echo "âŒ Backend dependency installation failed!"
              exit 1
            fi
            echo "âœ… Backend dependencies installed successfully"
          else
            echo "âŒ requirements.txt not found in backend directory!"
            exit 1
          fi
          
          # Build frontend
          echo "ğŸ—ï¸ Building frontend..."
          cd ../frontend
          npm run build
          if [ $? -ne 0 ]; then
            echo "âŒ Frontend build failed!"
            exit 1
          fi
          echo "âœ… Frontend built successfully"
          
          # Stop existing PM2 processes
          echo "ğŸ›‘ Stopping existing PM2 processes..."
          pm2 stop all 2>/dev/null || true
          pm2 delete all 2>/dev/null || true
          
          # Start applications with PM2
          echo "ğŸ”„ Starting applications with PM2..."
          cd /opt/hosting/static-ads-generator
          if [ -f ecosystem.config.js ]; then
            pm2 start ecosystem.config.js
            if [ $? -ne 0 ]; then
              echo "âŒ PM2 start failed!"
              exit 1
            fi
            echo "âœ… Applications started with PM2"
          else
            echo "âŒ ecosystem.config.js not found!"
            exit 1
          fi
          
          # Save PM2 configuration
          pm2 save
          
          # Show final status
          echo "ğŸ“Š Final PM2 Status:"
          pm2 status
          
          # Wait a moment for services to start
          sleep 5
          
          # Basic health check
          echo "ğŸ¥ Performing basic health checks..."
          if curl -f http://localhost:3000 >/dev/null 2>&1; then
            echo "âœ… Frontend is responding on port 3000"
          else
            echo "âš ï¸ Frontend may not be responding on port 3000"
          fi
          
          if curl -f http://localhost:8000/health >/dev/null 2>&1; then
            echo "âœ… Backend is responding on port 8000"
          else
            echo "âš ï¸ Backend may not be responding on port 8000"
          fi
          
          echo "âœ… Monorepo deployment complete!"
          echo "ğŸŒ Frontend: https://kraftey.com"
          echo "ğŸŒ Backend: https://staticapi.kraftey.com"
          
          # Setup SSL for backend (optional - uncomment if you want automatic SSL setup)
          # echo "ğŸ” Setting up SSL for backend..."
          # cd /opt/hosting/static-ads-generator
          # chmod +x scripts/setup-ssl.sh
          # ./scripts/setup-ssl.sh
        EOF


  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ¥ Health Check Frontend
      run: |
        sleep 30  # Wait for deployment to complete
        curl -f https://kraftey.com || exit 1
        echo "âœ… Frontend is healthy"

    - name: ğŸ¥ Health Check Backend
      run: |
        curl -f https://staticapi.kraftey.com/health || exit 1
        echo "âœ… Backend is healthy"

    - name: ğŸ“¢ Notify Deployment Success
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸŒ Frontend: https://kraftey.com"
        echo "ğŸŒ Backend: https://staticapi.kraftey.com"
        echo "ğŸ“Š API Docs: https://staticapi.kraftey.com/docs"