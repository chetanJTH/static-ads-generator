name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          # Navigate to project directory
          cd /opt/hosting/static-ads-generator
          
          # Stop PM2 services
          pm2 stop ecosystem.config.js || true
          
          # Pull latest changes
          git pull origin main
          
          # Fix permissions
          chown -R root:root .
          chmod -R 755 .
          chmod +x scripts/*.sh
          
          # Setup standardized environment files (prevents env variable issues)
          ./scripts/setup-env-files.sh
          
          # Install backend dependencies
          cd apps/backend
          pip3 install -r requirements.txt
          cd ..
          
          # Install frontend dependencies
          cd apps/frontend
          npm ci
          
          # Clean and build frontend
          rm -rf .next
          mkdir -p .next
          chmod 755 .next
          npm run build
          cd ..
          
          # Restart PM2 services
          pm2 start ecosystem.config.js
          pm2 save
          
          # Show status
          pm2 list